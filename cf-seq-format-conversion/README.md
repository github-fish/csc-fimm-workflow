# CSC-FIMM Format Conversion Workflow
This repository stores sequence format conversion workflows and testing results.   
This document offering the step-by-step introduction about sequence format conversion with GATK4 Docker images and Cromwell version 33 (or 36) on CSC cPouta VM.  
If you want to get more general information and pipelines about seq format conversion, you can check this [Github Page](https://github.com/gatk-workflows/seq-format-conversion).  
In this CSC-FIMM Format Conversion Workflow Github Page, we offers workflow scripts which suitable for running on cPouta VM and testing results. Tested on cPouta VM, 24 cores, 117.2GB RAM, with Swap 99 GB.  
## **paired-fastq-to-unmapped-bam:**
This WDL converts paired FASTQ to uBAM and adds read group information.  
**Requirements/expectations:**
  * Pair-end sequencing data in FASTQ format (one file per orientation).  
  * The following metada descriptors per sample:   
  ```bash
  readgroup   fastq_pair1_file_path   fastq_pair2_file_path   sample_name   library_name   platform_unit   run_date   platform_name   sequecing_center
  ```
**Outputs:**  
  * Set of unmapped BAMs, one per read group.  
  * File of a list of the generated unmapped BAMs.  

**Software version requirements:**  
  * GATK4 or later (Called as Docker image)  
  * Cromwell version support.  
    * Successfully tested on v33
    * Does not work on versions < v23 due to output syntax  

**Tool Prerequisites:**  
  * virtul machine (VM) on CSC cPouta
  * docker-ce
  * Git
## Running Instructions
### 1. Setup your working directory and make a directory to store your input files.
```bash
mkdir seq-format-conversion
cd seq-format-conversion
mkdir inputs
```
### 2. Git clone needed github repo.
```bash
git clone https:target-repository.git
```
### 3. Download Cromwell, the java excutable that will run the WDL.
```bash
wget https://github.com/broadinstitute/cromwell/releases/download/36/cromwell-36.jar #I successfully tested this with cromwell v33 on my own CSC VM, if you want to use the same one: wget https://github.com/broadinstitute/cromwell/releases/download/33/cromwell-33.jar
```
### 4. Download need input files which are specified in json files. Store them in inputs directory.   
```bash
cd inputs # Then download needed inputs file.
```
### 5. Edit the json file so that all file paths are replaced by your VM local file paths.
### 6. Change back to the main working dirctory.
```bash
cd ../
```
### 7. Execute your workflow.  
```bash
sudo systemctl restart docker
sudo time java -jar cromwell-36.jar run ./seq-format-conversion/paired-fastq-to-unmapped-bam.wdl -i ./seq-format-conversion/paired-fastq-to-unmapped-bam.inputs.json # "time" is optional for monitoring.
```
Tips: To excute your workflow, you always need to run:
````bash
sudo time java -jar cromwell-36(or other version).jar run /absolute-path/xxx.wdl -i /absolute-path/xxx.json   
```
For gatk4-data-processing: 
````bash
sudo time java -jar cromwell-36(or other version).jar run /absolute-path/processing-for-variant-discovery-gatk4.wdl -i /absolute-path/processing-for-variant-discovery-gatk4.hg38.wgs.inputs.NA12878(or NA12891, NA12892).json   
```
For gatk4-haplotypecaller:
````bash
sudo time java -jar cromwell-36(or other version).jar run /absolute-path/haplotypecaller-gvcf-gatk4.wdl -i /absolute-path/haplotypecaller-gvcf-gatk4.hg38.wgs.inputs.NA12878(or NA12891, NA12892).json   
```
### 8. Expected result.   
While the workflow is running cromwell will print out logs to your screen. Once it completes it will print out a message indicating the run was successful. Also, it will print out the location of the output files that was generated by your workflow.      
It will also generates two directories: cromwell-executions and cromwell-workflow-logs.   
## Testing Result
Pipelines were tested on cPouta VM (24 cores, 117.2 GB RAM with Swap 99G) with Sample NA12878, NA12891 and NA12892, separately. Other testing files/parameters are listed in each json file. More detailed info and TerminalSavedOutput can be found in TestingResult Folder.
